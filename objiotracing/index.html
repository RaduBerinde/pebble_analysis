<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Obj IO tracing viz</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/uplot@1.6.9/dist/uPlot.min.css">
    <style>
        .uplot {
            display: inline-block;
            vertical-align: top;
        }
        .u-legend.u-inline .u-value {
             width: 100px;
             text-align: left;
         }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 20px;
            background: #04AA6D;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 10px;
            height: 20px;
            background: #04AA6D;
            cursor: pointer;
        }
    </style>
</head>

<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://unpkg.com/uplot@1.6.9/dist/uPlot.iife.js"></script>

<div>
    <label for="traces_dropdown">Trace:</label>
    <select id="traces_dropdown"><option value=""></option></select>
</div>

<div id="trace_plot_div">
</div>

<script>
    let dropdown = document.getElementById("traces_dropdown");
    $.get("http://localhost:8089/list", function (data) {
        let response = JSON.parse(data);
        console.log(data);
        console.log(response);
        response.traces.forEach(function(w) {
            let el = document.createElement("option");
            el.value = w;
            el.textContent = w;
            dropdown.appendChild(el);
        })
    })

    var plot = null;
    var plotDiv = document.getElementById("trace_plot_div")

    dropdown.onchange = function() {
        if (plot) {
            plot.destroy();
            plot = null;
        }
        while (plotDiv.firstChild) {
            plotDiv.removeChild(plotDiv.firstChild);
        }
        if (dropdown.value == "") {
            return;
        }
        let p = document.createElement("p");
        p.innerHTML = 'Generating plot...';
        plotDiv.append(p)
        $.post("http://localhost:8089/plot", JSON.stringify({ trace: dropdown.value }), function (respData) {
            let res = JSON.parse(respData);
            let opts = {
                title: dropdown.value,
                width: 1200,
                height: 600,
                axes: [
                    {},
                    {
                        label: "MB/s",
                    }
                ],
                series: [
                    {},
                    {
                        label: "Reads",
                        stroke: "rgb(255,0,0)",
                        value: (u, v) => v.toFixed(2) + " MB/s",
                        show: false,
                    },
                    {
                        label: "Writes",
                        stroke: "rgb(0,0,255)",
                        value: (u, v) => v.toFixed(2) + " MB/s",
                        show: false,
                    },
                    {
                        label: "Hits" ,
                        stroke: "rgb(0,255,0)",
                        value: (u, v) => v.toFixed(2) + " MB/s",
                        show: false,
                    },
                    {
                        label: "Reads L5+" ,
                        stroke: "rgb(128,30,30)",
                        value: (u, v) => v.toFixed(2) + " MB/s",
                    },
                    {
                        label: "Writes L5+" ,
                        stroke: "rgb(30,30,128)",
                        value: (u, v) => v.toFixed(2) + " MB/s",
                    },
                    {
                        label: "Hits L5+" ,
                        stroke: "rgb(30,128,30)",
                        value: (u, v) => v.toFixed(2) + " MB/s",
                    },
                ],
            };
            let data = [
                res.time_axis_unix_secs,
                res.read_mbps,
                res.write_mbps,
                res.cache_hit_mbps,
                res.read_mbps_l5_l6,
                res.write_mbps_l5_l6,
                res.cache_hit_mbps_l5_l6,
            ];

            plotDiv.removeChild(plotDiv.firstChild)
            plot = new uPlot(opts, data, plotDiv)

            console.log(res);
        })
    }
</script>

</body>
</html>
